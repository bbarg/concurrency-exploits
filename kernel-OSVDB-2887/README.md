# `do_brk()` bug on RedHat 8

Steps for reproducing the `do_brk()` exploit on RedHat 8, running Linux kernel version 2.4.18. More information can be found at:
- http://isec.pl/papers/linux_kernel_do_brk.pdf

## Install RedHat 8

*The following installation was carried out on VMware Workstation 10 on a Gentoo-3.10.x host.*

Go to ftp://archive.download.redhat.com/pub/redhat/linux/8.0/en/iso/i386/ and download the first 2 ISO images (numbers 3 thru 5 are for extra packages we don't need).

Create a "RedHat Linux" virtual machine.

Select `psyche-i386-disc1.iso` for the install disk. Also check "Connected" for the CD/DVD drive type, as this allows swapping in the secondary install CDs.

Hit enter upon initial bootup to select the GUI install.

Skip the CD-ROM check.
Command sequence:
- next
- next
- next
- next
- next (select "Workstation" installation type)
- next (automatically partition)
- next (Remove all Linux partitions on this system)
- yes
- next
- next
- next (default firewall rules)
- next (no additional language support)
- next (choose your time zone)
- next (choose a simple root password and create a user account)
- next (default packages, you can take some out if you want to make things go faster)
- next (start the installation)

You may have to swap secondary install discs in during the installation. To do so, open up the VM's settings window and under "Hardware -> CD/DVD" change the file under "Use an ISO image".

Now the installation is done:
- next (we don't need a boot disk)
- next (generic GUI driver)
- next (use "Unprobed Monitor" unless you want to take the time to customize)
- next (default display settings)

System reboot.

Final configurations:
- foward
- forward (date and time should set just fine)
- forward
- forward (don't register system with Red Hat Network)
- forward (don't need to install additional CDs)

## Run Exploit
Download `hatorihanzo.c` from sebug.net/paper/linux_exp/2.4.23/hatorihanzo.c.
Compile with `-static` option:
```bash
gcc -static hatorihanzo.c -o hator 
```
Run the executable. You should obtain root shell (with a prompt like `sh-2.05b#`). Try `touch /root/evil` to check if you actually have privileges. I ran it about 10 or so times in a row by hand and had it succeed every time. Interestingly, if you background `hator` with `./hator &` it blocks on the root shell exec call, which you can obtain by foregrounding it again (`fg`).

## Further Options

It was suggested in http://www.ukcert.org.uk/repository/library/do_brk_root.pdf that system instability could ensue after running the bug multiple times, due to kernel memory corruption. If you want to run the exploit a bunch of times in succession to test this, use `try.sh`. It's my suspicion that this issue might have been fixed later on by the folks at ISEC (who wrote the exploit), given that the linked paper at the top of this readme talks about kernel memory cleanup. 

If you want to do more creative things, `./hator noshell` will just print the uid and exit once it obtains root, instead of exec-ing a root shell.